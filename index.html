<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Body Dashboard - Sorin</title>
    <!-- MODIFICAT: Adăugăm SDK-ul Firebase/Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS-ul rămâne identic cu cel de la versiunea Supabase */
        :root { --orange: #FF6B00; --dark-bg: #121212; --card-bg: #1E1E1E; --text-primary: #E0E0E0; --text-secondary: #BDBDBD; --border-color: #333; --font-heading: 'Poppins', sans-serif; --font-body: 'Roboto', sans-serif; }
        body { margin: 0; font-family: var(--font-body); background-color: var(--dark-bg); color: var(--text-primary); }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { text-align: center; margin-bottom: 40px; }
        header h1 { font-family: var(--font-heading); color: var(--orange); font-size: 2.5rem; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .card { background-color: var(--card-bg); border-radius: 8px; padding: 25px; border: 1px solid var(--border-color); }
        .card h2 { font-family: var(--font-heading); margin-top: 0; border-bottom: 2px solid var(--orange); padding-bottom: 10px; }
        form { display: flex; flex-direction: column; gap: 15px; }
        form label { font-weight: 700; color: var(--text-secondary); }
        form input { background-color: #2C2C2C; border: 1px solid var(--border-color); color: var(--text-primary); padding: 10px; border-radius: 4px; font-size: 1rem; }
        form button { background-color: var(--orange); color: white; border: none; padding: 12px; font-size: 1rem; font-weight: bold; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; }
        form button:hover { background-color: #e65c00; }
        .chart-container { position: relative; width: 100%; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .stat h3 { margin: 0; color: var(--text-secondary); font-size: 0.9rem; }
        .stat p { margin: 5px 0 0; font-size: 1.8rem; font-weight: 700; color: var(--orange); }
    </style>
</head>
<body>
    <!-- HTML-ul rămâne identic -->
    <div class="container">
        <header><h1>Body Dashboard</h1><p>Monitorizarea progresului către obiectivul de 40 de ani.</p></header>
        <div class="dashboard">
            <div class="card">
                <h2>Status Curent</h2>
                <div class="stats-grid">
                    <div class="stat"><h3>Greutate (kg)</h3><p id="stat-weight">--</p></div>
                    <div class="stat"><h3>Masa Musc. (%)</h3><p id="stat-muscle">--</p></div>
                    <div class="stat"><h3>Piept (cm)</h3><p id="stat-chest">--</p></div>
                    <div class="stat"><h3>Coapse (cm)</h3><p id="stat-thigh">--</p></div>
                </div>
                <hr>
                <div class="stats-grid">
                    <div class="stat"><h3>IMC</h3><p id="stat-bmi">--</p></div>
                    <div class="stat"><h3>Greutate Ideală</h3><p id="stat-ideal-weight">--</p></div>
                    <div class="stat"><h3>Categorie IMC</h3><p id="stat-bmi-cat">--</p></div>
                    <div class="stat"><h3>BMR (kcal/zi)</h3><p id="stat-bmr">--</p></div>
                    <div class="stat"><h3>TDEE (kcal/zi)</h3><p id="stat-tdee">--</p></div>
                </div>
            </div>
            <div class="card"><h2>Înregistrare Zilnică</h2><form id="daily-form"><input type="date" id="daily-date" required><input type="number" step="0.1" id="weight" placeholder="Greutate (kg)" required><input type="number" step="0.1" id="muscle" placeholder="Masa Musculară (%)"><input type="number" id="calories" placeholder="Calorii (kcal)"><button type="submit">Salvează</button></form></div>
            <div class="card"><h2>Măsurători Corporale</h2><form id="measurements-form"><input type="date" id="measure-date" required><input type="number" step="0.1" id="chest" placeholder="Piept (cm)"><input type="number" step="0.1" id="shoulders" placeholder="Umeri (cm)"><input type="number" step="0.1" id="thigh" placeholder="Coapse (cm)"><input type="number" step="0.1" id="calf" placeholder="Gambe (cm)"><button type="submit">Salvează Măsurători</button></form></div>
            <div class="card" style="grid-column: 1 / -1;"><h2>Progres Greutate</h2><div class="chart-container"><canvas id="weightChart"></canvas></div></div>
            <div class="card" style="grid-column: 1 / -1;"><h2>Progres Măsurători</h2><div class="chart-container"><canvas id="measurementsChart"></canvas></div></div>
        </div>
    </div>

<script>
    // --- CONFIGURARE FIREBASE ---
    // !!! ÎNLOCUIEȘTE ACEST OBIECT CU CEL DIN CONSOLA TA FIREBASE !!!
    
   // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
        apiKey: "AIzaSyDa2r9t3kWGUpoiuqRaaKvYpWlJ_V8-yMI",
        authDomain: "body-dashboard-sorin.firebaseapp.com",
        projectId: "body-dashboard-sorin",
        storageBucket: "body-dashboard-sorin.firebasestorage.app",
        messagingSenderId: "895437811384",
        appId: "1:895437811384:web:6f735fd10b35bf448fce4d",
        measurementId: "G-JYGMGKFQB8"
    };

    // Inițializează Firebase și Firestore
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- Referințe DOM ---
    const dailyForm = document.getElementById('daily-form');
    const measurementsForm = document.getElementById('measurements-form');
    document.getElementById('daily-date').valueAsDate = new Date();
    document.getElementById('measure-date').valueAsDate = new Date();
    let weightChart, measurementsChart;

    // --- Funcții Bază de Date (MODIFICATE PENTRU FIRESTORE) ---
    async function logDailyEntry(e) {
        e.preventDefault();
        const entry = {
            date: document.getElementById('daily-date').value,
            weight_kg: parseFloat(document.getElementById('weight').value) || null,
            muscle_mass_percent: parseFloat(document.getElementById('muscle').value) || null,
            calories_kcal: parseInt(document.getElementById('calories').value) || null,
        };
        try {
            await db.collection('daily_entries').add(entry);
            alert('Date zilnice salvate!');
            dailyForm.reset();
            document.getElementById('daily-date').valueAsDate = new Date();
            loadAllData();
        } catch (error) {
            alert('Eroare la salvare: ' + error.message);
        }
    }

    async function logMeasurements(e) {
        e.preventDefault();
        const entry = {
            date: document.getElementById('measure-date').value,
            chest_cm: parseFloat(document.getElementById('chest').value) || null,
            shoulders_cm: parseFloat(document.getElementById('shoulders').value) || null,
            thigh_cm: parseFloat(document.getElementById('thigh').value) || null,
            calf_cm: parseFloat(document.getElementById('calf').value) || null,
        };
        try {
            await db.collection('measurements').add(entry);
            alert('Măsurători salvate!');
            measurementsForm.reset();
            document.getElementById('measure-date').valueAsDate = new Date();
            loadAllData();
        } catch (error) {
            alert('Eroare la salvare: ' + error.message);
        }
    }

    async function loadAllData() {
        try {
            // Fetch daily entries
            const dailySnapshot = await db.collection('daily_entries').orderBy('date').get();
            const dailyData = dailySnapshot.docs.map(doc => doc.data());
            
            // Fetch measurements
            const measureSnapshot = await db.collection('measurements').orderBy('date').get();
            const measureData = measureSnapshot.docs.map(doc => doc.data());

            updateDashboard(dailyData, measureData);
            renderCharts(dailyData, measureData);
        } catch (error) {
            console.error('Error fetching data:', error);
        }
    }
    
    // --- Funcțiile de UI (updateDashboard, renderCharts) rămân identice ---
    function updateDashboard(dailyData, measureData) { /* ... cod identic ca înainte ... */ }
    function renderCharts(dailyData, measureData) { /* ... cod identic ca înainte ... */ }
    
    // Copiază aici funcțiile `updateDashboard` și `renderCharts` din versiunea anterioară
    // (Le-am omis pentru a nu încărca răspunsul, dar ele trebuie să fie aici)
    function updateDashboard(dailyData, measureData) {
        // Date personale
        const sex = 'male';
        const birthDate = new Date('1985-09-08');
        const height_cm = 173;
        let weight_kg = 83; // default dacă nu există date

        if (dailyData.length > 0) {
            const lastDaily = dailyData[dailyData.length - 1];
            weight_kg = lastDaily.weight_kg || weight_kg;
            document.getElementById('stat-weight').textContent = lastDaily.weight_kg || '--';
            document.getElementById('stat-muscle').textContent = lastDaily.muscle_mass_percent || '--';
        } else {
            document.getElementById('stat-weight').textContent = weight_kg;
            document.getElementById('stat-muscle').textContent = '--';
        }
        if (measureData.length > 0) {
            const lastMeasure = measureData[measureData.length - 1];
            document.getElementById('stat-chest').textContent = lastMeasure.chest_cm || '--';
            document.getElementById('stat-thigh').textContent = lastMeasure.thigh_cm || '--';
        }

        // Calcule automate
        const height_m = height_cm / 100;
        const bmi = (weight_kg / (height_m * height_m)).toFixed(1);

        // Greutate ideală (Devine formula pentru bărbați)
        const ideal_weight = (50 + 0.9 * (height_cm - 152)).toFixed(1);

        // Categorie IMC
        let bmi_cat = '';
        if (bmi < 18.5) bmi_cat = 'Subponderal';
        else if (bmi < 25) bmi_cat = 'Normal';
        else if (bmi < 30) bmi_cat = 'Supraponderal';
        else bmi_cat = 'Obezitate';

        // Vârstă
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        if (
            today.getMonth() < birthDate.getMonth() ||
            (today.getMonth() === birthDate.getMonth() && today.getDate() < birthDate.getDate())
        ) {
            age--;
        }

        // BMR (Mifflin-St Jeor pentru bărbați)
        // sport saptamanal => activitate moderată (factor 1.55)
        const bmr = Math.round(10 * weight_kg + 6.25 * height_cm - 5 * age + 5);
        const tdee = Math.round(bmr * 1.55);

        document.getElementById('stat-bmi').textContent = bmi;
        document.getElementById('stat-ideal-weight').textContent = ideal_weight + ' kg';
        document.getElementById('stat-bmi-cat').textContent = bmi_cat;
        document.getElementById('stat-bmr').textContent = bmr;
        document.getElementById('stat-tdee').textContent = tdee;
    }
    function renderCharts(dailyData, measureData) {
        const chartOptions = { scales: { x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } }, y: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } } }, plugins: { legend: { labels: { color: 'white' } } } };
        if (weightChart) weightChart.destroy();
        const weightCtx = document.getElementById('weightChart').getContext('2d');
        weightChart = new Chart(weightCtx, { type: 'line', data: { labels: dailyData.map(d => new Date(d.date).toLocaleDateString('ro-RO')), datasets: [ { label: 'Greutate (kg)', data: dailyData.map(d => d.weight_kg), borderColor: 'var(--orange)', tension: 0.1, fill: false }, { label: 'Masa Musculară (%)', data: dailyData.map(d => d.muscle_mass_percent), borderColor: '#4299E1', tension: 0.1, fill: false } ] }, options: chartOptions });
        if (measurementsChart) measurementsChart.destroy();
        const measureCtx = document.getElementById('measurementsChart').getContext('2d');
        measurementsChart = new Chart(measureCtx, { type: 'line', data: { labels: measureData.map(d => new Date(d.date).toLocaleDateString('ro-RO')), datasets: [ { label: 'Piept (cm)', data: measureData.map(d => d.chest_cm), borderColor: '#F56565', tension: 0.1, fill: false }, { label: 'Coapse (cm)', data: measureData.map(d => d.thigh_cm), borderColor: '#48BB78', tension: 0.1, fill: false }, { label: 'Umeri (cm)', data: measureData.map(d => d.shoulders_cm), borderColor: '#ED8936', tension: 0.1, fill: false } ] }, options: chartOptions });
    }

    // --- Inițializare ---
    dailyForm.addEventListener('submit', logDailyEntry);
    measurementsForm.addEventListener('submit', logMeasurements);
    document.addEventListener('DOMContentLoaded', loadAllData);
</script>
</body>
</html>